<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Reading OPUS binary files from Bruker® spectrometers in R • opusreader2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Reading OPUS binary files from Bruker® spectrometers in R">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">opusreader2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/opusreader2_introduction.html">Reading OPUS binary files from Bruker® spectrometers in R</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/spectral-cockpit/opusreader2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Reading OPUS binary files from Bruker® spectrometers in R</h1>
                        <h4 data-toc-skip class="author">Philipp Baumann
and Thomas Knecht</h4>
            
            <h4 data-toc-skip class="date">2025-05-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/spectral-cockpit/opusreader2/blob/main/vignettes/opusreader2_introduction.Rmd" class="external-link"><code>vignettes/opusreader2_introduction.Rmd</code></a></small>
      <div class="d-none name"><code>opusreader2_introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>Spectrometers from <a href="https://www.bruker.com/en.html" class="external-link">Bruker®
Optics GmbH &amp; Co.</a> save spectra in a special file format called
OPUS. Each OPUS file is linked to one aggregated sample measurement,
which is usually obtained using the OPUS spectroscopy software. These
files have numbers as file extensions, and the numbers typically
increase sequentially for each sample name, based on the settings chosen
in the OPUS software. The OPUS suite and file specification are
proprietary, so we had to implement this package using reverse
engineering. With opusreader2, you can extract your spectroscopic data
directly in R, giving you full control over your spectral data workflow.
Our package is designed to handle binary files for most
Fourier-Transform Infrared (FT-IR) spectrometers from Bruker® Optics
GmbH. It might also work for other products, such as Raman
spectrometers, but in these cases, additional adjustments may be needed
to support new block types (for<br>
both data and parameters; see below).</p>
</div>
<div class="section level2">
<h2 id="opus-data-extraction">OPUS data extraction<a class="anchor" aria-label="anchor" href="#opus-data-extraction"></a>
</h2>
<p>Each OPUS file is processed by first extracting metadata information
from a<br>
dedicated part of the file header. This section contains all the
important information about binary blocks (also called chunks), such as
byte offsets, sizes, and data types at different byte locations in the
file. The parsing algorithm uses this information to extract various
data and parameter blocks from byte sequences. As the picture below
shows, the content of the files changes based on the instrument type,
the data (spectrum) blocks that the user chooses to save, and the
specific measurement settings.</p>
<div class="float" id="fig:opus_settings">
<img src="images/opus-measurement-settings.png" alt="OPUS measurement settings for Bruker INVENIO® Fourier-transform (FT) mid-infrared spectrometer"><div class="figcaption">OPUS measurement settings for Bruker INVENIO®
Fourier-transform (FT)<br>
mid-infrared spectrometer</div>
</div>
<p>In addition to result spectra, the binary files include:</p>
<ul>
<li>a comprehensive set of measurement parameters (configurations,
conditions)</li>
<li>single-channel data from background measurements performed before
the sample</li>
<li>other types of intermediate spectra</li>
</ul>
<p>Currently, we support the <em>“data blocks to be saved”</em> for
Fourier-transform infrared spectrometers.</p>
<div class="section level3">
<h3 id="reading-and-parsing-opus-files-in-r">Reading and parsing OPUS files in R<a class="anchor" aria-label="anchor" href="#reading-and-parsing-opus-files-in-r"></a>
</h3>
<p>The main function, <code><a href="../reference/read_opus.html">read_opus()</a></code>, reads one or more OPUS
files and returns a nested list of class <code>list_opusreader2</code>.
Each list contains both the spectral data and metadata for each
file.</p>
<p>Let’s see how this works using an example file from a Bruker ALPHA®
spectrometer. This instrument measures mid-infrared spectra, here using
a diffuse-reflectance accessory. The soil sample measurement shown is
included with the package and is also part of the data set in <a href="https://soil.copernicus.org/articles/7/717/2021/" class="external-link">Baumann et
al. (2020)</a>.</p>
<div class="float">
<img src="images/OPUS_block1.png" alt="Data parameters for absorbance (AB) spectrum"><div class="figcaption">Data parameters for absorbance (AB)
spectrum</div>
</div>
<p>We can extract all these blocks from the example OPUS file. In fact,
we can access even more blocks than are displayed in the official OPUS
software.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://spectral-cockpit.github.io/opusreader2/">"opusreader2"</a></span><span class="op">)</span></span>
<span><span class="co"># example file</span></span>
<span><span class="va">file_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"test_data"</span>, <span class="st">"BF_lo_01_soil_cal.1"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"opusreader2"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">spectrum_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_opus.html">read_opus</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="va">file_1</span><span class="op">)</span></span></code></pre></div>
<p>The <code>dsn</code> argument is the data source name. It can be a
character vector of folder paths (to read files recursively) or specific
OPUS file paths.</p>
<p><strong><code><a href="../reference/read_opus.html">read_opus()</a></code></strong> returns a nested list of
class <code>"list_opusreader2"</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">spectrum_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "list"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">spectrum_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>At the top level, the list structure matches how data is organized in
the Bruker OPUS viewer.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meas_1</span> <span class="op">&lt;-</span> <span class="va">spectrum_1</span><span class="op">[[</span><span class="st">"BF_lo_01_soil_cal.1"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">meas_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>To understand block names and their contents, see the help page
<code><a href="../reference/read_opus.html">?read_opus</a></code>. Block names use <code>camel_case</code> at the
second level of the <code>"opusreader2_list"</code> output, making them
easy to access programmatically.</p>
<p>Printing the entire <code>"opusreader2_list"</code> can flood the
console. For easier exploration, use RStudio’s <em>list preview</em>
with <code>View(spectrum_1)</code> or examine specific elements with
<code><a href="https://rdrr.io/r/base/names.html" class="external-link">names()</a></code> and <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code>.</p>
<p>Some list elements may not be visible in the Bruker® viewer pane, but
we compile them because they are either useful or actually part of the
files:</p>
<ol style="list-style-type: decimal">
<li>
<code>basic_metadata</code>: Minimal metadata to identify
measurements, including file name, sample name, and timestamps. Useful
for organizing spectral libraries and prediction workflows.</li>
<li>
<code>ab_no_atm_comp_data_param</code>: Parameters for the
absorbance (AB) block before atmospheric compensation.</li>
<li>
<code>ab_no_atm_comp</code>: Absorbance data before atmospheric
compensation.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">meas_1</span><span class="op">$</span><span class="va">basic_metadata</span><span class="op">)</span></span>
<span><span class="co">#&gt;  NULL</span></span></code></pre></div>
<p>All types of data and parameters within OPUS files are encoded with
three capital letters each.</p>
<p>For example, to check the frequency of the first point (FXV),
use:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meas_1</span><span class="op">$</span><span class="va">ab_data_param</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">FXV</span><span class="op">$</span><span class="va">parameter_value</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>Besides the data or parameter values, the output of each parsed OPUS
block contains the block type, channel type, text type, additional type,
the offset in bytes, next offset in bytes, and the chunk size in bytes
for particular data blocks. This is decoded from the file header and
allows for traceability in the parsing process.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">meas_1</span><span class="op">$</span><span class="va">ab_data_param</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "NULL"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">meas_1</span><span class="op">$</span><span class="va">ab_data_param</span><span class="op">)</span></span>
<span><span class="co">#&gt;  NULL</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">meas_1</span><span class="op">$</span><span class="va">instrument</span><span class="op">)</span></span>
<span><span class="co">#&gt;  NULL</span></span></code></pre></div>
<p>This example spectrum was measured with atmospheric compensation
(removing masking information from carbon dioxide and water vapor
bands), as set in the OPUS software. OPUS files track all processing
steps and macros, so you can access both raw and processed data. This
enables thorough quality control before modeling or making predictions
on new samples.</p>
</div>
<div class="section level3">
<h3 id="reading-opus-files-recursively-from-a-folder">Reading OPUS files recursively from a folder<a class="anchor" aria-label="anchor" href="#reading-opus-files-recursively-from-a-folder"></a>
</h3>
<p>You can also provide a folder as the data source name
(<code>dsn</code>). This makes it easy to read all OPUS files found
within a folder and its subfolders. Here, we demonstrate this using the
test files that come with the {opusreader2} package, which are also used
for unit testing.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_dsn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"test_data"</span>, package <span class="op">=</span> <span class="st">"opusreader2"</span><span class="op">)</span></span>
<span><span class="va">data_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_opus.html">read_opus</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="va">test_dsn</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data_test</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>To get the instrument name from each test file, you can use:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_instrument_name</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">instrument</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">INS</span><span class="op">$</span><span class="va">parameter_value</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_test</span>, <span class="va">get_instrument_name</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "INVENIO-R"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "VERTEX 70"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] "Alpha"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] "Tango"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1] "TENSOR II"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="reading-opus-files-in-parallel">Reading OPUS files in parallel<a class="anchor" aria-label="anchor" href="#reading-opus-files-in-parallel"></a>
</h3>
<p>We implemented a parallel interface in <code><a href="../reference/read_opus.html">read_opus()</a></code> to
efficiently read large collections of spectra from multiple OPUS files.
The default and recommended backend, <a href="https://mirai.r-lib.org/" class="external-link">mirai</a>, orchestrates reading files
concurrently using asynchronous parallel mapping over individual OPUS
files. The main advantage is faster reads, better and also
fault-tolerant error handling (i.e. custom) actions when a file cannot
be read.</p>
<p>Behind the scene, mirai uses <a href="https://github.com/r-lib/nanonext/" class="external-link">nanonext</a> and <a href="https://nng.nanomsg.org/" class="external-link">NNG</a> (Nanomsg Next Gen) messaging,
which allows high throughput and low latency between individual R
processes.</p>
<p>All you have to do is launching daemons.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://shikokuchuo.net/mirai/" class="external-link">"mirai"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mirai/man/daemons.html" class="external-link">daemons</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2L</span>, dispatcher <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
<p>The task of reading files can be done locally or through distributed
systems over a network. For further details, check out the mirai, and
its vignettes.</p>
</div>
<div class="section level3">
<h3 id="reading-a-single-opus-file">Reading a single OPUS file<a class="anchor" aria-label="anchor" href="#reading-a-single-opus-file"></a>
</h3>
<p>For individual OPUS files, you can use the
<code><a href="../reference/read_opus_single.html">read_opus_single()</a></code> function. We export it as a developer
interface.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_opus_single.html">read_opus_single</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="va">file_1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philipp Baumann, Thomas Knecht, Pierre Roudier, spectral-cockpit.com.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
