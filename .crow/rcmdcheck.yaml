when:
  - event: [pull_request, manual]
  - event: push
    branch: $CI_REPO_DEFAULT_BRANCH

steps:
  'Check package':
    image: reg.devxy.io/r/r-alpine:4-3.22
    pull: true
    environment:
      RCMDCHECK_NUM_COLORS: 300
      PKG_SYSREQS_PLATFORM: alpine
      PKG_SYSREQS: TRUE
      PKG_SYSREQS_VERBOSE: TRUE
    commands:
      - apk add -q pandoc
      - R -q -e 'dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)'
      - R -q -e 'install.packages("pak", repos = sprintf("https://r-lib.github.io/p/pak/stable/%s/%s/%s", .Platform$pkgType, R.Version()$os, R.Version()$arch))'
      - R -q -e 'options(Ncpus = 4); pak::pak(); pak::pak("r-lib/rcmdcheck"); rcmdcheck::rcmdcheck(build_args = c("--no-build-vignettes"), args = c("--no-manual", "--as-cran"), error_on = "warning")'
